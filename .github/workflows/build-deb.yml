name: Build and Release MOS FileBrowser Plugin

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [amd64, arm64]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build Vue Plugin Page
        run: |
          cd page
          npm install
          npm run build

      - name: Create package structure
        run: |
          PKG_NAME="mos-file-browser"
          VERSION=${{ steps.get_version.outputs.VERSION }}
          ARCH=${{ matrix.arch }}
          PKG_DIR="${PKG_NAME}_${VERSION}_${ARCH}"
          
          # Create directory structure
          mkdir -p "${PKG_DIR}/DEBIAN"
          mkdir -p "${PKG_DIR}/boot/config/plugins/${PKG_NAME}"
          mkdir -p "${PKG_DIR}/boot/config/plugins/${PKG_NAME}/page"
          
          # Create control file
          cat > "${PKG_DIR}/DEBIAN/control" << EOF
          Package: ${PKG_NAME}
          Version: ${VERSION}
          Section: utils
          Priority: optional
          Architecture: ${ARCH}
          Maintainer: RiDDiX <info@yoursite.com>
          Description: MOS FileBrowser Plugin
           A file browser plugin for MOS that allows browsing disks, shares,
           and pools, editing text files, and managing files directly from
           the MOS web interface.
          EOF
          
          # Create postinst script
          cat > "${PKG_DIR}/DEBIAN/postinst" << 'EOF'
          #!/bin/bash
          set -e
          PLG_DIR="/boot/config/plugins/mos-file-browser"
          
          # Source the functions file and run install
          if [ -f "${PLG_DIR}/functions" ]; then
            source "${PLG_DIR}/functions"
            install
          fi
          
          exit 0
          EOF
          chmod 755 "${PKG_DIR}/DEBIAN/postinst"
          
          # Create prerm script
          cat > "${PKG_DIR}/DEBIAN/prerm" << 'EOF'
          #!/bin/bash
          set -e
          PLG_DIR="/boot/config/plugins/mos-file-browser"
          
          # Source the functions file and run uninstall
          if [ -f "${PLG_DIR}/functions" ]; then
            source "${PLG_DIR}/functions"
            uninstall
          fi
          
          exit 0
          EOF
          chmod 755 "${PKG_DIR}/DEBIAN/prerm"
          
          # Copy plugin files
          cp -r page/dist/* "${PKG_DIR}/boot/config/plugins/${PKG_NAME}/page/" 2>/dev/null || true
          cp functions "${PKG_DIR}/boot/config/plugins/${PKG_NAME}/"
          cp settings.json "${PKG_DIR}/boot/config/plugins/${PKG_NAME}/" 2>/dev/null || true
          cp README.md "${PKG_DIR}/boot/config/plugins/${PKG_NAME}/" 2>/dev/null || true
          
          # Build the package
          dpkg-deb --build "${PKG_DIR}"
          
          # Rename to standard format
          mv "${PKG_DIR}.deb" "${PKG_NAME}-${VERSION}-${ARCH}.deb"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: deb-${{ matrix.arch }}
          path: "*.deb"

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: "MOS FileBrowser Plugin v${{ steps.get_version.outputs.VERSION }}"
          body: |
            ## MOS FileBrowser Plugin v${{ steps.get_version.outputs.VERSION }}
            
            ### Features
            - Browse disks, shares, and pools
            - Edit text and config files
            - Copy and move files
            - Calculate directory sizes
            
            ### Installation
            Download the appropriate .deb file for your architecture and install via MOS Hub or manually.
          files: artifacts/**/*.deb
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
